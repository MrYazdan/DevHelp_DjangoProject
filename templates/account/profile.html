{% extends 'landing/base.html' %}
{% load i18n %}
{% block title %}{% trans "Profile" %}{% endblock %}
{% block offer %}{% endblock %}
{% block click_item %}{% endblock %}
{% block body %}
    <div class="trs-all-300 relative max-w-screen-lg relative mx-auto w-11/12 gap-4 grid grid-cols-1 sm:grid-cols-3 md:grid-cols-4 rounded-md bg-black mt-8 bg-opacity-30 mb-8 z-10 overflow-hidden">
        <div class="right bg-black bg-opacity-30 border-l border-white border-opacity-30">
            <a href="{% url "profile" %}" id="account"
               class="block cursor-pointer text-shadow-md text-white irsans-b py-5 text-center border-b border-white border-opacity-30 trs-all-300 bg-white bg-opacity-10">{% trans "User profile" %}</a>
            <a href="{% url "address" %}" id="addrss"
               class="cursor-pointer block text-shadow-md text-white irsans-b py-5 text-center border-b border-white border-opacity-30 trs-all-300 bg-white bg-opacity-0 hover:bg-opacity-10">{% trans "Registered addresses" %}</a>
            <a href="{% url "user_orders" %}" id="order"
               class="cursor-pointer block text-shadow-md text-white irsans-b py-5 text-center border-b border-white border-opacity-30 trs-all-300 bg-white bg-opacity-0 hover:bg-opacity-10">{% trans "Registered orders" %}</a>
            <a href="{% url "user_offcode" %}" id="offcode"
               class="cursor-pointer block text-shadow-md text-white irsans-b py-5 text-center border-b border-white border-opacity-30 trs-all-300 bg-white bg-opacity-0 hover:bg-opacity-10">{% trans "Active discount codes" %}</a>
        </div>
        <div id="main" class="left col-span-1 sm:col-span-2 md:col-span-3 py-4 pl-4 pr-4 sm:pr-0">
            <div id="account-data">
                <h2 class="text-center text-white text-shadow-md irsans-b mt-2 mb-6 border-b-2 border-gray-400 rounded-full pb-4">{% trans "User information" %}</h2>
                <form>
                    <label for="first_name" class="inline-block w-full mb-2 mr-3 text-white">{% trans "First name" %}
                        : </label>
                    <input class="trs-all-300 inline-block py-4 w-full rounded-md px-3 bg-black bg-opacity-30 mb-4 text-white"
                           type="text" id="first_name" name="first_name" value="{{ user.first_name }}"
                           placeholder="{% trans "Please enter your first name" %}"><br>
                    <label for="last_name" class="inline-block w-full mb-2 mr-3 text-white">{% trans "Last name" %}
                        : </label>
                    <input class="trs-all-300 inline-block py-4 w-full rounded-md px-3 bg-black bg-opacity-30 mb-4 text-white"
                           type="text" id="last_name" name="last_name" value="{{ user.last_name }}"
                           placeholder="{% trans "Please enter your last name" %}"><br>
                    <label for="ncode" class="inline-block w-full mb-2 mr-3 text-white">{% trans "National code" %} : </label>
                    <input class="trs-all-300 inline-block py-4 w-full rounded-md px-3 bg-black bg-opacity-30 mb-4 text-white"
                           min="10" max="10" type="text" id="ncode" name="ncode" value="{{ user.ncode }}"
                           placeholder="{% trans "Please enter your national code" %}"><br>
                    <label for="phone" class="inline-block w-full mb-2 mr-3 text-white">{% trans "Phone number" %}
                        :</label>
                    <input class="trs-all-300 inline-block py-4 w-full rounded-md px-3 bg-black bg-opacity-30 mb-4 text-gray-400 cursor-not-allowed"
                           disabled title="{% trans "Uneditable" %}" type="text" id="phone" name="phone"
                           value="{{ user.phone }}"><br>
                    <label for="email" class="inline-block w-full mb-2 mr-3 text-white">{% trans "Email" %} : </label>
                    <input class="trs-all-300 inline-block py-4 w-full rounded-md px-3 bg-black bg-opacity-30 mb-4 text-gray-400 cursor-not-allowed"
                           disabled title="{% trans "Uneditable" %}" type="text" id="email" name="email"
                           value="{{ user.email }}"><br>
                    <div class="grid grid-cols-1 gap-4 mt-2 ltr text-white">
                        <button onclick="ProfileUpdater($(this))" type="button"
                                class="text-center py-3 rounded-md trs-all-300 bg-green-600  hover:bg-green-700 text-shadow-md cursor-pointer">{% trans "Save" %}</button>
                    </div>
                </form>

                <!-- change password -->
                <h2 class="text-center text-white text-shadow-md irsans-b mt-8 mb-6 border-b-2 border-gray-400 rounded-full pb-4">{% trans "Change Password" %}</h2>
                <form action="">
                    <label for="old_password" class="inline-block w-full mb-2 mr-3 text-white">{% trans "Old password" %}
                        : </label>
                    <input class="trs-all-300 inline-block py-4 w-full rounded-md px-3 bg-black bg-opacity-30 mb-4 text-white"
                           type="password" id="old_password" name="old_password"
                           placeholder="{% trans "Please enter your old password" %}"><br>
                    <label for="new_password1" class="inline-block w-full mb-2 mr-3 text-white">{% trans "New password" %}
                        : </label>
                    <input class="trs-all-300 inline-block py-4 w-full rounded-md px-3 bg-black bg-opacity-30 mb-4 text-white"
                           type="password" id="new_password1" name="new_password1"
                           placeholder="{% trans "Please enter your new password" %}"><br>
                    <label for="new_password2"
                           class="inline-block w-full mb-2 mr-3 text-white">{% trans "Confirm password" %} : </label>
                    <input class="trs-all-300 inline-block py-4 w-full rounded-md px-3 bg-black bg-opacity-30 mb-4 text-white"
                           type="password" id="new_password2" name="new_password2"
                           placeholder="{% trans "Please enter your confirm password" %}"><br>
                    <div class="grid grid-cols-1 gap-4 mt-2 ltr text-white">
                        <button onclick="PasswordUpdater($(this))" type="button"
                                class="text-center py-3 rounded-md trs-all-300 bg-green-600  hover:bg-green-700 text-shadow-md cursor-pointer">{% trans "Change password" %}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}
{% block extra_foot %}
    <script>
        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                }
            }
        });

        function ProfileUpdater(el) {
            let el_fname = $('#first_name')
            let el_lname = $('#last_name')
            let el_ncode = $('#ncode')

            $.ajax({
                url: '{% url "api:user_detail" user.id %}',
                type: 'PATCH', contentType: 'application/json',
                data: JSON.stringify({
                    'first_name': el_fname.val(),
                    'last_name': el_lname.val(),
                    'ncode': el_ncode.val()
                }),
                error: function (xhr, status, error) {
                    let err = JSON.parse(xhr.responseText);
                    let _text = ""
                    $.each(err, function (k, v) {
                        let key = $("[for=" + k + "]").text()
                        _text += key + v + "\n"
                    })

                    Swal.fire({
                        icon: 'error',
                        title: '{% trans "Control the inputs!" %}',
                        text: _text,
                        showConfirmButton: false, timer: 8500, timerProgressBar: true,
                    })
                }
            }).done(function () {
                Swal.fire({
                    icon: 'success',
                    title: '{% trans "Changes were applied!" %}',
                    showConfirmButton: false, timer: 3500, timerProgressBar: true,
                })
            })
        }

        function PasswordUpdater(el) {
            let el_old = $('#old_password')
            let el_new = $('#new_password1')
            let el_confirm = $('#new_password2')

            $.ajax({
                url: '{% url "api:change_password" pk=user.id %}',
                type: 'PATCH', contentType: 'application/json',
                data: JSON.stringify({
                    'old_password': el_old.val(),
                    'new_password1': el_new.val(),
                    'new_password2': el_confirm.val()
                }),
                error: function (xhr, status, error) {
                    let err = JSON.parse(xhr.responseText);
                    let _text = ""
                    $.each(err, function (k, v) {
                        let key = $("[for=" + k + "]").text()
                        _text += "<p>" + key + v + "</p>"
                    })

                    Swal.fire({
                        icon: 'error',
                        title: '{% trans "Control the inputs!" %}',
                        html: _text,
                        showConfirmButton: false, timer: 8500, timerProgressBar: true,
                    })
                }
            }).done(function () {
                Swal.fire({
                    icon: 'success',
                    title: '{% trans "New password changed successfully!" %}',
                    text: '{% trans 'Redirect to login page, please log in again' %}',
                    showConfirmButton: false, timer: 4000, timerProgressBar: true,
                }).then((result) => {
                    if (result.dismiss) {
                        window.location.replace("{% url "login" %}");
                    }
                })
            })
        }
    </script>
{% endblock %}